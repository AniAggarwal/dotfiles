# Source Zap Plugin Manager
[ -f "$HOME/.local/share/zap/zap.zsh" ] && source "$HOME/.local/share/zap/zap.zsh"

###########
# Plugins #
###########
plug "zsh-users/zsh-autosuggestions"
plug "jeffreytse/zsh-vi-mode"
# plug "kutsan/zsh-system-clipboard"
plug "zsh-users/zsh-syntax-highlighting"
plug "conda-incubator/conda-zsh-completion"

###########
# Options #
###########

HISTFILE=~/.histfile
HISTSIZE=10000
SAVEHIST=10000
# Using case insensitive completion
CASE_SENSITIVE="false"
# Autocorrect commands
ENABLE_CORRECTION="true"
COMPLETION_WAITING_DOTS="false"

export EDITOR="/home/ani/.local/bin/nvim"
export PATH="$HOME/.local/bin:$PATH"
export PATH=$PATH:/home/ani/.spicetify

# Append to hist file rather than overwrite
setopt INC_APPEND_HISTORY
# Ignore duplicates when using up/down arrow
setopt HIST_FIND_NO_DUPS
# Don't add duplicates to hist file
setopt HIST_IGNORE_DUPS
# Use #, ~, ^ as patterns. Raise error if no match
setopt extendedglob nomatch
# Highlight matches when completing
zstyle ':completion:*' menu select

# Setup conda completions. fpath must be set before compinit
fpath+=$ZAP_PLUGIN_DIR/conda-zsh-completion
compinit

# Show hidden files when completing
_comp_options+=(globdots)

# Try searching history before using zsh's completion
ZSH_AUTOSUGGEST_STRATEGY=(history completion)

# Use wlc as clipboard method.
# TODO: not working currently. Wait util PR is merged to vi-mode
# ZSH_SYSTEM_CLIPBOARD_METHOD="wlc"

####################
# Custom Functions #
####################

export FZF_DEFAULT_COMMAND="fdfind --type f --strip-cwd-prefix --hidden --exclude .git --exclude miniconda3"
function fzf_open_file {
    local file
    { file="$(fzf)" && [ -f "$file" ] && xdg-open "$file" &> /dev/null } </dev/tty
}

##################
# Plugin Configs #
##################

# zsh-vi-mode config
function zvm_config() {
    # Use the better key engine
    ZVM_READKEY_ENGINE=$ZVM_READKEY_ENGINE_NEX
    # Use insert mode by default
    ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
    # TODO: this doesn't work yet
    # jk to switch to command mode
    ZVM_VI_ESCAPE_BINDKEY=jk
    # Switching between Insert and Normal mode have less timeout but not too low so that jk works
    ZVM_KEYTIMEOUT=0.1
    echo 'hi'

    # Change highlight colors
    # TODO: make zsh highlight which sugession from list we are selecting
    ZVM_VI_HIGHLIGHT_BACKGROUND=#3e4452
    ZVM_VI_HIGHLIGHT_FOREGROUND=#abb3be
}

# Fix compatibility issues with zsh-vi-mode
function zvm_after_init() {
    # Use FZF's completion and keybinds
    [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

    export FZF_CTRL_T_COMMAND='fdfind --type f --strip-cwd-prefix --hidden --exclude .git --exclude miniconda3'
    export FZF_CTRL_T_OPTS="
    --preview 'bat -n --color=always {}'
    --bind 'ctrl-/:change-preview-window(down|hidden|)'"

    export FZF_CTRL_R_OPTS="
    --preview 'echo {}' --preview-window up:3:hidden:wrap
    --bind 'ctrl-/:toggle-preview'
    --color header:italic
    --header 'Press CTRL-/ to show full command.'"

    export FZF_ALT_C_COMMAND='fdfind --strip-cwd-prefix --hidden --exclude .git --exclude miniconda3'
    export FZF_ALT_C_OPTS="--preview 'tree -C {}'"

    # Ctrl+space to accept suggestion, ctrl+enter to acecpt, execute
    bindkey '^ ' autosuggest-accept
    # TODO: execute doesn't work, using kitty workaround for now
    # bindkey '^\n' autosuggest-execute

    zvm_define_widget fzf_open_file
    bindkey '^o' fzf_open_file

    # Aliases
    if [ -f ~/.aliases ]; then
        . ~/.aliases
    fi

    # Fixes https://github.com/jeffreytse/zsh-vi-mode/pull/188
    autoload add-zle-hook-widget
    add-zle-hook-widget zle-line-pre-redraw zvm_zle-line-pre-redraw
}


#############################
# Autogenerated Code Blocks #
#############################

# Miniconda
# >>> conda initialize >>>
# !! Contents within this block are managed by 'conda init' !!
__conda_setup="$('/home/ani/miniconda3/bin/conda' 'shell.zsh' 'hook' 2> /dev/null)"
if [ $? -eq 0 ]; then
    eval "$__conda_setup"
else
    if [ -f "/home/ani/miniconda3/etc/profile.d/conda.sh" ]; then
        . "/home/ani/miniconda3/etc/profile.d/conda.sh"
    else
        export PATH="/home/ani/miniconda3/bin:$PATH"
    fi
fi
unset __conda_setup
# <<< conda initialize <<<


###################
# Starship prompt #
###################

eval "$(starship init zsh)"
